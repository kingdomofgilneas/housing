<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Directory - The Neighborhoods of Gilneas</title>

  <style>
    html, body { height: 100%; margin: 0; background: #000; }

    #loading-screen {
      position: fixed;
      inset: 0;
      z-index: 9999;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #loading-screen .loading-bg {
      position: absolute;
      inset: 0;
      background: url('assets/loadingbackground.png') center/cover no-repeat rgba(0,0,0,0.85);
      filter: brightness(0.4) blur(2px);
      z-index: 1;
    }

    .loading-content {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .loading-pulse {
      position: relative;
      opacity: 0.9;
      animation: pulse 4.5s ease-in-out infinite;
      filter: drop-shadow(0 0 8px rgba(0,0,0,0.7));
    }

    #loading-screen img.loading-pulse {
      width: 400px !important;
      height: 400px !important;
      max-width: none !important;
      max-height: none !important;
      object-fit: contain;
      display: block;
    }

    .loading-text {    
      font-size: 40px;
      color: #ffffff;
      font-family: Arial, sans-serif;
      text-shadow: 0 0 10px rgba(0,0,0,0.9);
      font-weight: bold;
      z-index: 3;
      pointer-events: none;
    }
    
    @keyframes pulse {
      0%   { transform: scale(1.00); opacity: 0.92; }
      50%  { transform: scale(1.03); opacity: 1.0; }
      100% { transform: scale(1.00); opacity: 0.92; }
    }

    #top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 68px;
      background: rgba(0, 0, 0, 0.9);
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      z-index: 9000;
      font-family: Arial, sans-serif;
      color: #f5f5f5;
      gap: 10px;
      box-sizing: border-box;
    }
    #top-bar .top-title {
      font-weight: bold;
      white-space: nowrap;
    }
    #top-bar .top-left {
      display: flex;
      align-items: center;
      gap: 8px;
      height: 68px;
      min-width: 180px;
    }
    .top-logo {
      height: calc(100% - 6px);
      margin: 3px 0;
      width: auto;
      object-fit: contain;
    }

    #top-bar .top-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    #subdivision-filter,
    #type-filter,
    #sort-select {
      background: #1b1b1b;
      color: #f5f5f5;
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 13px;
      font-family: Arial, sans-serif;
    }
    #subdivision-filter:focus,
    #type-filter:focus,
    #sort-select:focus {
      outline: none;
      border-color: #ffffff;
    }

    #search-input {
      background: #111;
      color: #f5f5f5;
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 13px;
      font-family: Arial, sans-serif;
      min-width: 180px;
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }
    #search-input::placeholder {
      color: #888;
    }
    #search-input:focus {
      outline: none;
    }
    #search-input.search-visual-focus {
      border-color: #ffffff;
      box-shadow: 0 0 6px rgba(255,255,255,0.5);
    }

    #app {
      position: absolute;
      top: 68px;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      min-height: 0;
      background:
        radial-gradient(circle at top, rgba(30,30,30,0.35), rgba(0,0,0,1) 55%),
        #000;
      font-family: Arial, sans-serif;
      color: #eee;
    }

    #sidebar {
      flex: 0 0 40%;
      max-width: 40%;
      min-width: 460px;
      border-right: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.55);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .sidebar-header {
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0.55));
    }

    .directory-title {
      font-size: 18px;
      font-weight: 700;
      color: #fbac3a;
      margin-bottom: 4px;
    }

    .directory-meta {
      font-size: 12px;
      color: #aaa;
    }

    #plot-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px 12px 14px 12px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .plot-row {
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(10, 10, 10, 0.85);
      padding: 14px 14px;
      box-sizing: border-box;
      cursor: pointer;
      transition: transform 0.12s ease, border-color 0.12s ease, background 0.12s ease;
      overflow: visible;
      position: relative;
      display: flex;
      gap: 14px;
      align-items: flex-start;
    }

    .plot-row:hover {
      transform: translateY(-1px);
      border-color: rgba(255, 255, 255, 0.30);
      background: rgba(18, 18, 18, 0.95);
    }

    .plot-row.selected {
      border-color: rgba(251, 172, 58, 0.55);
      box-shadow: 0 0 0 1px rgba(251, 172, 58, 0.25), 0 0 14px rgba(251, 172, 58, 0.12);
      background: rgba(22, 18, 10, 0.92);
    }

    .row-emoji {
      width: 36px;
      text-align: center;
      font-size: 26px;
      line-height: 26px;
      filter: drop-shadow(0 0 3px rgba(0,0,0,0.8));
      flex: 0 0 36px;
      margin-top: 4px;
    }

    .row-main {
      min-width: 0;
      flex: 1;
      overflow: visible;
    }

    .row-title {
      font-size: 16px;
      font-weight: 800;
      color: #f5f5f5;
      line-height: 1.25;
      margin: 0 0 6px 0;
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
      word-break: break-word;
    }

    .row-sub {
      font-size: 13px;
      color: #bbb;
      margin: 0 0 10px 0;
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
      word-break: break-word;
    }

    .row-preview {
      font-size: 13px;
      color: #d6d6d6;
      line-height: 1.45;
      max-height: none;
      overflow: visible;
      opacity: 0.92;
      word-break: break-word;
      white-space: normal;
    }

    #content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      min-height: 0;
      padding: 16px;
      gap: 14px;
      box-sizing: border-box;
    }

    #info-panel {
      flex: 0 0 30%;
      min-height: 240px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(8, 8, 8, 0.92);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 30px rgba(0,0,0,0.55);
    }

    .panel-head {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(to bottom, rgba(0,0,0,0.85), rgba(0,0,0,0.45));
    }

    #info-title {
      font-size: 28px;
      font-weight: 700;
      color: #fbac3a;
      margin: 0 0 8px 0;
      line-height: 1.12;
    }

    #info-subtitle {
      font-size: 16px;
      color: #ccc;
      font-style: italic;
      margin: 0;
    }

    #info-body {
      padding: 14px 16px 16px 16px;
      overflow-y: auto;
      font-size: 17px;
      color: #ddd;
      line-height: 1.55;
      min-height: 0;
    }

    #photos-panel {
      flex: 1;
      min-height: 220px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: radial-gradient(circle at top, #222 0, #050505 60%);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 30px rgba(0,0,0,0.55);
    }

    .photos-head {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(to bottom, rgba(0,0,0,0.85), rgba(0,0,0,0.45));
      font-size: 12px;
      color: #aaa;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    #photos-strip {
      flex: 1;
      padding: 14px 16px;
      box-sizing: border-box;
      min-height: 0;
    
      display: grid;
      gap: 14px;
    
      grid-template-columns: repeat(5, minmax(0, 1fr));
      align-content: start;
    
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    #photos-strip img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      cursor: pointer;
      box-shadow: 0 0 20px rgba(0,0,0,0.55);
      transition: transform 0.12s ease, border-color 0.12s ease;
    }
    
    #photos-strip img:hover {
      transform: translateY(-2px);
      border-color: rgba(255,255,255,0.38);
    }

    #photos-placeholder {
      padding: 14px 16px;
      font-size: 15px;
      color: #aaa;
    }

    .empty-state {
      margin: 12px 14px 14px 14px;
      padding: 12px;
      border: 1px dashed rgba(255,255,255,0.18);
      border-radius: 8px;
      color: #aaa;
      background: rgba(0,0,0,0.35);
    }

    #image-lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.92);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 16px;
      box-sizing: border-box;
    }
    
    .lightbox-inner {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #image-lightbox img {
      max-width: 100% !important;
      max-height: 80vh !important;
      width: auto !important;
      height: auto !important;
      object-fit: contain !important;
      display: block;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.9);
    }
    
    #lightbox-close {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: none;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.9);
    }

    #lightbox-prev,
    #lightbox-next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(0,0,0,0.60);
      color: #fff;
      font-size: 28px;
      line-height: 44px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 0 14px rgba(0,0,0,0.85);
      user-select: none;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    #lightbox-prev { left: 10px; }
    #lightbox-next { right: 10px; }

    #lightbox-prev:hover,
    #lightbox-next:hover {
      background: rgba(0,0,0,0.80);
      border-color: rgba(255,255,255,0.45);
    }

    @media (max-width: 680px) {
      #lightbox-prev,
      #lightbox-next {
        width: 40px;
        height: 40px;
        font-size: 26px;
        line-height: 40px;
      }
    }

    @media (max-width: 980px) {
      #app {
        flex-direction: column;
      }
      #sidebar {
        flex: none;
        max-width: none;
        width: 100%;
        height: 46%;
        min-width: 0;
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.14);
      }
      #content {
        height: 54%;
        padding: 12px;
      }
      #info-panel {
        flex: 0 0 54%;
      }
      #info-title {
        font-size: 24px;
      }
      #info-body {
        font-size: 16px;
      }
      #photos-strip img {
        max-height: 200px;
      }
    }
  </style>
</head>

<body>
  <div id="top-bar">
    <div class="top-left">
      <img src="assets/logo.png" alt="Logo" class="top-logo">
      <div class="top-title">KoG Housing</div>
    </div>

    <div class="top-right">
      <select id="subdivision-filter">
        <option value="">All Subdivisions</option>
        <option value="Subdivision 1">Subdivision 1</option>
        <option value="Subdivision 2">Subdivision 2</option>
        <option value="Subdivision 3">Subdivision 3</option>
        <option value="Subdivision 4">Subdivision 4</option>
        <option value="Other Locations">Other Locations</option>
      </select>

      <select id="type-filter" style="display:none;">
        <option value="">All Types</option>
      </select>

      <select id="sort-select">
        <option value="title-asc">Title A-Z</option>
        <option value="title-desc">Title Z-A</option>
        <option value="plot-asc">Plot # ASC</option>
        <option value="plot-desc">Plot # DESC</option>
      </select>

      <input id="search-input" type="text" placeholder="Search...">
    </div>
  </div>

  <div id="loading-screen">
    <div class="loading-bg"></div>
    <div class="loading-content">
      <img src="assets/loadinglogo.png" alt="Loading…" class="loading-pulse">
      <div class="loading-text">LOADING</div>
    </div>
  </div>

  <div id="app">
    <div id="sidebar">
      <div class="sidebar-header">
        <div class="directory-title" id="directory-title">Location Directory</div>
        <div class="directory-meta" id="directory-meta">Loading plots…</div>
      </div>
      <div id="plot-list"></div>
      <div class="empty-state" id="empty-state" style="display:none;"></div>
    </div>

    <div id="content">
      <div id="info-panel">
        <div class="panel-head">
          <h2 id="info-title">No plot selected</h2>
          <p id="info-subtitle"></p>
        </div>
        <div id="info-body"></div>
      </div>

      <div id="photos-panel">
        <div class="photos-head">PHOTOS</div>
        <div id="photos-strip"></div>
        <div id="photos-placeholder">Select a plot to view any available images.</div>
      </div>
    </div>
  </div>

  <div id="image-lightbox">
    <div class="lightbox-inner">
      <button id="lightbox-prev" type="button" aria-label="Previous image">‹</button>
      <img id="lightbox-image" src="" alt="Plot image">
      <button id="lightbox-next" type="button" aria-label="Next image">›</button>
      <button id="lightbox-close" type="button">×</button>
    </div>
  </div>

  <script>
    const DATA_URL = 'https://script.google.com/macros/s/AKfycbx4mYuCwK4vJzNZ9tGvc0I_xvtBkQ2XyobdeTKmR0RT_1_WOi4dLNPVEScFxrvrUWVFMQ/exec';
    const IMAGE_URL = 'https://script.google.com/macros/s/AKfycbxw1ZXiaI8xwKzeiMKCYvIHMUb-i-Fa_S1LOj9laRzKtidj-A785dSklyUgGideEa5N/exec';

    function showLoadingScreen() {
      const el = document.getElementById('loading-screen');
      if (el) el.style.display = 'flex';
    }

    function hideLoadingScreen() {
      const el = document.getElementById('loading-screen');
      if (el) el.style.display = 'none';
    }

    function formatInfoText(raw) {
      if (!raw) return '';

      let txt = raw
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      txt = txt.replace(/\r\n|\r|\n/g, '<br>');
      txt = txt.replace(/\*\*\*([\s\S]+?)\*\*\*/g, '<strong><em>$1</em></strong>');
      txt = txt.replace(/\*\*([\s\S]+?)\*\*/g, '<strong>$1</strong>');
      txt = txt.replace(/\*([\s\S]+?)\*/g, '<em>$1</em>');
      txt = txt.replace(/__([\s\S]+?)__/g, '<u>$1</u>');
      txt = txt.replace(/~~([\s\S]+?)~~/g, '<s>$1</s>');

      return txt;
    }

    const lightbox       = document.getElementById('image-lightbox');
    const lightboxImage  = document.getElementById('lightbox-image');
    const lightboxClose  = document.getElementById('lightbox-close');
    const lightboxPrev   = document.getElementById('lightbox-prev');
    const lightboxNext   = document.getElementById('lightbox-next');

    let currentLightboxImages = [];
    let currentLightboxIndex = 0;

    function updateLightboxNavVisibility() {
      const show = currentLightboxImages && currentLightboxImages.length > 1;
      lightboxPrev.style.display = show ? 'flex' : 'none';
      lightboxNext.style.display = show ? 'flex' : 'none';
    }

    function openLightboxAtIndex(index) {
      if (!currentLightboxImages || currentLightboxImages.length === 0) return;
      const max = currentLightboxImages.length - 1;
      currentLightboxIndex = Math.max(0, Math.min(index, max));
      lightboxImage.src = currentLightboxImages[currentLightboxIndex];
      lightbox.style.display = 'flex';
      updateLightboxNavVisibility();
    }

    function showNext() {
      if (!currentLightboxImages || currentLightboxImages.length < 2) return;
      currentLightboxIndex = (currentLightboxIndex + 1) % currentLightboxImages.length;
      lightboxImage.src = currentLightboxImages[currentLightboxIndex];
    }

    function showPrev() {
      if (!currentLightboxImages || currentLightboxImages.length < 2) return;
      currentLightboxIndex = (currentLightboxIndex - 1 + currentLightboxImages.length) % currentLightboxImages.length;
      lightboxImage.src = currentLightboxImages[currentLightboxIndex];
    }

    function closeLightbox() {
      lightbox.style.display = 'none';
      lightboxImage.src = '';
      currentLightboxIndex = 0;
    }

    lightboxPrev.addEventListener('click', function (e) {
      e.stopPropagation();
      showPrev();
    });

    lightboxNext.addEventListener('click', function (e) {
      e.stopPropagation();
      showNext();
    });

    lightboxImage.addEventListener('click', function (e) {
      e.stopPropagation();
    });

    lightboxClose.addEventListener('click', function (e) {
      e.stopPropagation();
      closeLightbox();
    });

    lightbox.addEventListener('click', function (e) {
      if (e.target === lightbox) closeLightbox();
    });

    document.addEventListener('keydown', function (e) {
      if (lightbox.style.display !== 'flex') return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showPrev();
      if (e.key === 'ArrowRight') showNext();
    });

    function getSubdivisionIndexFromName(name) {
      var m = (name || '').match(/(\d+)/);
      var n = m ? Number(m[1]) : 1;
      return isNaN(n) ? 1 : n;
    }

    function extractPlotNumber(row) {
      if (row.owner !== undefined && row.owner !== null) {
        let v = String(row.owner).trim();
        v = v.replace(/^plot\s*/i, '');
        return v;
      }
      return null;
    }

    function safeString(v) {
      return (v === undefined || v === null) ? '' : String(v);
    }

    function numericPlot(plotNumber) {
      const n = parseFloat(String(plotNumber || '').match(/[\d.]+/)?.[0]);
      return isNaN(n) ? null : n;
    }

    const listEl = document.getElementById('plot-list');
    const emptyEl = document.getElementById('empty-state');
    const metaEl = document.getElementById('directory-meta');

    const infoTitleEl = document.getElementById('info-title');
    const infoSubtitleEl = document.getElementById('info-subtitle');
    const infoBodyEl = document.getElementById('info-body');

    const photosStripEl = document.getElementById('photos-strip');
    const photosPlaceholderEl = document.getElementById('photos-placeholder');

    const subdivisionFilterEl = document.getElementById('subdivision-filter');
    const typeFilterEl = document.getElementById('type-filter');
    const sortEl = document.getElementById('sort-select');
    const searchEl = document.getElementById('search-input');

    let allRows = [];
    let filteredRows = [];
    let selectedKey = null;

    function buildTypeFilterOptions(rows) {
      const types = new Set();
      rows.forEach(r => {
        const t = safeString(r.type).trim();
        if (t) types.add(t);
      });

      const sorted = Array.from(types).sort((a, b) => a.localeCompare(b));
      const current = typeFilterEl.value;

      typeFilterEl.innerHTML = '';
      const allOpt = document.createElement('option');
      allOpt.value = '';
      allOpt.textContent = 'All Types';
      typeFilterEl.appendChild(allOpt);

      sorted.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        typeFilterEl.appendChild(opt);
      });

      if ([...typeFilterEl.options].some(o => o.value === current)) {
        typeFilterEl.value = current;
      } else {
        typeFilterEl.value = '';
      }
    }

    function normalizeRows(markers, sheetName) {
      const subIndex = getSubdivisionIndexFromName(sheetName);

      return (markers || []).map(row => {
        const rawTitle = safeString(row.title) || 'Unknown';
        const plotNumber = extractPlotNumber(row);
        const key = sheetName + '|' + safeString(plotNumber) + '|' + rawTitle;

        return {
          key,
          rawTitle,
          titleShort: rawTitle.length > 48 ? rawTitle.substring(0, 46) + '…' : rawTitle,
          info: safeString(row.info),
          owner: safeString(row.owner),
          type: safeString(row.type),
          plotNumber: plotNumber,
          plotNumberNumeric: numericPlot(plotNumber),
          subdivisionName: sheetName,
          subdivisionIndex: subIndex
        };
      });
    }

    function escapeHtml(s) {
      return String(s || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function renderList(rows) {
      listEl.innerHTML = '';
      emptyEl.style.display = 'none';

      metaEl.textContent = rows.length + ' plots shown';

      if (!rows.length) {
        emptyEl.style.display = 'block';
        emptyEl.innerHTML = '<strong>No results.</strong><br>';
        return;
      }

      rows.forEach(r => {
        const rowEl = document.createElement('div');
        rowEl.className = 'plot-row';
        rowEl.dataset.key = r.key;

        const emoji = safeString(r.type).trim() || '•';

        let preview = safeString(r.info).trim();
        preview = preview.replace(/\r\n|\r|\n/g, ' ');

        const subTextParts = [];
        if (r.plotNumber) subTextParts.push('Plot ' + r.plotNumber);
        const subText = subTextParts.length ? subTextParts.join(' · ') : '—';

        rowEl.innerHTML = `
          <div class="row-emoji" title="${escapeHtml(emoji)}">${escapeHtml(emoji)}</div>
          <div class="row-main">
            <div class="row-title">${escapeHtml(r.rawTitle)}</div>
            <div class="row-sub">${escapeHtml(r.subdivisionName)} · ${escapeHtml(subText)}</div>
            <div class="row-preview">${escapeHtml(preview || 'No description provided.')}</div>
          </div>
        `;

        rowEl.addEventListener('click', () => {
          selectRow(r.key);
        });

        listEl.appendChild(rowEl);
      });

      updateSelectedVisual();
    }

    function updateSelectedVisual() {
      const nodes = listEl.querySelectorAll('.plot-row');
      nodes.forEach(n => {
        if (n.dataset.key === selectedKey) n.classList.add('selected');
        else n.classList.remove('selected');
      });
    }

    function selectRow(key) {
      selectedKey = key;
      updateSelectedVisual();

      const row = allRows.find(r => r.key === key) || filteredRows.find(r => r.key === key);
      if (!row) return;

      infoTitleEl.textContent = row.rawTitle || 'Plot';
      if (row.plotNumber != null && row.plotNumber !== '') {
        infoSubtitleEl.textContent = row.subdivisionName + ' · Plot ' + row.plotNumber;
      } else {
        infoSubtitleEl.textContent = row.subdivisionName || '';
      }
      infoBodyEl.innerHTML = formatInfoText(row.info || '');

      loadImagesForRow(row);
    }

    function loadImagesForRow(row) {
      photosStripEl.innerHTML = '';
      photosPlaceholderEl.style.display = 'block';
      photosPlaceholderEl.textContent = 'Looking for images for this plot...';

      const sub = (safeString(row.subdivisionName).trim() === 'Other Locations') ? 'Other' : (row.subdivisionIndex || 1);
      const plotNumber = row.plotNumber;

      if (plotNumber == null || plotNumber === '') {
        photosPlaceholderEl.textContent = 'No plot number found for this entry.';
        currentLightboxImages = [];
        currentLightboxIndex = 0;
        updateLightboxNavVisibility();
        return;
      }

      var url =
        IMAGE_URL +
        '?action=images' +
        '&sub=' + encodeURIComponent(String(sub)) +
        '&plot=' + encodeURIComponent(String(plotNumber));

      fetch(url)
        .then(function (r) {
          if (!r.ok) throw new Error('Image fetch failed');
          return r.json();
        })
        .then(function (data) {
          var images = (data && data.images) ? data.images : [];
          renderDriveImagesStrip_(images);
        })
        .catch(function (err) {
          console.error(err);
          photosPlaceholderEl.style.display = 'block';
          photosPlaceholderEl.textContent = 'Could not load images for this plot.';
          currentLightboxImages = [];
          currentLightboxIndex = 0;
          updateLightboxNavVisibility();
        });
    }

    function renderDriveImagesStrip_(images) {
      photosStripEl.innerHTML = '';

      if (!images || images.length === 0) {
        photosPlaceholderEl.style.display = 'block';
        photosPlaceholderEl.textContent = 'No images found for this plot.';
        currentLightboxImages = [];
        currentLightboxIndex = 0;
        updateLightboxNavVisibility();
        return;
      }

      photosPlaceholderEl.style.display = 'none';

      currentLightboxImages = images.map(function (item) {
        return item.thumbUrl ? item.thumbUrl.replace('sz=w1200','sz=w3000') : item.url;
      });
      currentLightboxIndex = 0;
      updateLightboxNavVisibility();

      images.forEach(function (item, index) {
        var img = document.createElement('img');
        img.src = item.thumbUrl || item.url;
        img.referrerPolicy = 'no-referrer';
        img.alt = item.name || 'Plot image';

        img.addEventListener('click', function () {
          openLightboxAtIndex(index);
        });

        photosStripEl.appendChild(img);
      });
    }

    function applyFilters() {
      const q = (searchEl.value || '').trim().toLowerCase();
      const type = (typeFilterEl.value || '').trim();
      const subdivision = (subdivisionFilterEl.value || '').trim();
      const sortMode = sortEl.value;

      filteredRows = allRows.filter(r => {
        if (subdivision && safeString(r.subdivisionName).trim() !== subdivision) return false;
        if (type && safeString(r.type).trim() !== type) return false;

        if (!q) return true;

        const haystack = (
          safeString(r.rawTitle) + ' ' +
          safeString(r.titleShort) + ' ' +
          safeString(r.owner) + ' ' +
          safeString(r.info) + ' ' +
          safeString(r.type) + ' ' +
          safeString(r.plotNumber) + ' ' +
          safeString(r.subdivisionName) + ' ' +
          safeString(r.subdivisionIndex)
        ).toLowerCase();

        return haystack.indexOf(q) !== -1;
      });

      filteredRows.sort((a, b) => {
        if (sortMode === 'title-asc') return a.rawTitle.localeCompare(b.rawTitle);
        if (sortMode === 'title-desc') return b.rawTitle.localeCompare(a.rawTitle);

        if (sortMode === 'type-asc') return safeString(a.type).localeCompare(safeString(b.type));

        if (sortMode === 'plot-asc') {
          const an = a.plotNumberNumeric;
          const bn = b.plotNumberNumeric;
          if (an == null && bn == null) return a.rawTitle.localeCompare(b.rawTitle);
          if (an == null) return 1;
          if (bn == null) return -1;
          if (an !== bn) return an - bn;
          return a.rawTitle.localeCompare(b.rawTitle);
        }

        if (sortMode === 'plot-desc') {
          const an = a.plotNumberNumeric;
          const bn = b.plotNumberNumeric;
          if (an == null && bn == null) return a.rawTitle.localeCompare(b.rawTitle);
          if (an == null) return 1;
          if (bn == null) return -1;
          if (an !== bn) return bn - an;
          return a.rawTitle.localeCompare(b.rawTitle);
        }

        return 0;
      });

      renderList(filteredRows);

      if (selectedKey) {
        const stillExists = filteredRows.some(r => r.key === selectedKey);
        if (!stillExists) {
          selectedKey = null;
          updateSelectedVisual();
          infoTitleEl.textContent = 'No plot selected';
          infoSubtitleEl.textContent = '';
          infoBodyEl.innerHTML = '';
          photosStripEl.innerHTML = '';
          photosPlaceholderEl.style.display = 'block';
          photosPlaceholderEl.textContent = 'Select a plot to view any available images.';
          currentLightboxImages = [];
          currentLightboxIndex = 0;
          updateLightboxNavVisibility();
        }
      }
    }

    async function loadAllNeighborhoods(sheetNames) {
      showLoadingScreen();
      metaEl.textContent = 'Loading plots…';

      try {
        const results = await Promise.all(sheetNames.map(async (sheetName) => {
          const url = DATA_URL + '?sheet=' + encodeURIComponent(sheetName);
          const res = await fetch(url);
          if (!res.ok) throw new Error('Network response not ok for ' + sheetName);
          const data = await res.json();
          return normalizeRows(data.markers || [], sheetName);
        }));

        allRows = results.flat();
        buildTypeFilterOptions(allRows);
        applyFilters();
        hideLoadingScreen();

        if (filteredRows.length) {
          selectRow(filteredRows[0].key);
          const firstNode = listEl.querySelector('.plot-row');
          if (firstNode) firstNode.scrollIntoView({ block: 'nearest' });
        }
      } catch (error) {
        console.error('Error fetching combined data:', error);
        hideLoadingScreen();

        allRows = [];
        listEl.innerHTML = '';
        emptyEl.style.display = 'block';
        emptyEl.innerHTML =
          '<strong>Could not load one or more subdivisions.</strong><br>' +
          'Check the Apps Script URL and your sheet names.';
        metaEl.textContent = 'Load failed';
      }
    }

    subdivisionFilterEl.addEventListener('change', applyFilters);
    typeFilterEl.addEventListener('change', applyFilters);
    sortEl.addEventListener('change', applyFilters);

    if (searchEl) {
      searchEl.addEventListener('input', applyFilters);

      searchEl.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') e.preventDefault();
      });

      searchEl.addEventListener('focus', function () {
        searchEl.classList.add('search-visual-focus');
      });
      searchEl.addEventListener('blur', function () {
        searchEl.classList.remove('search-visual-focus');
      });
    }

    window.addEventListener('load', function () {
      loadAllNeighborhoods([
        'Subdivision 1',
        'Subdivision 2',
        'Subdivision 3',
        'Subdivision 4',
        'Other Locations'
      ]);
    });
  </script>
</body>
</html>
